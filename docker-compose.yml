version: '3.9'

services:
  # Servidores Web Sub-rede A
  webserver_a:
    build:
      context: ./webserver_A
    networks:
      subnet_a:
        ipv4_address: 10.0.0.10
    ports:
      - "8080:80"

  # Servidores Web Sub-rede B
  webserver_b:
    build:
      context: ./webserver_B
    networks:
      subnet_b:
        ipv4_address: 20.0.0.10
    ports:
      - "8081:80"

  # Servidor DNS Sub-rede A
  dns_a:
    build:
      context: ./dns_A
    networks:
      subnet_a:
        ipv4_address: 10.0.0.11
    ports:
      - "5355:53/udp"  # Porta para DNS
    cap_add:
      - NET_ADMIN

  # Servidor DNS Sub-rede B
  dns_b:
    build:
      context: ./dns_B
    networks:
      subnet_b:
        ipv4_address: 20.0.0.11
    ports:
      - "5356:53/udp"
    cap_add:
      - NET_ADMIN

# Firewall e DHCP
  firewall:
    build:
      context: ./firewall
    networks:
      subnet_a:
      subnet_b:
    cap_add:
      - NET_ADMIN
    ports:
      - "67:67/udp"
      - "68:68/udp"
    command: >
      sh -c "
        apt update &&
        apt install -y iptables isc-dhcp-server tcpdump &&
        echo 'INTERFACESv4=\"eth0 eth1\"' > /etc/default/isc-dhcp-server &&
        sysctl -w net.ipv4.ip_forward=1 &&  # Habilita o roteamento
        sysctl -w net.ipv6.conf.all.disable_ipv6=1 &&
        apt update && apt install -y iputils-ping &&
        iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE &&
        iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT &&
        iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT &&
        iptables -A INPUT -p udp --dport 5355 -j ACCEPT &&
        iptables -A INPUT -p udp --dport 5356 -j ACCEPT &&
        iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o eth1 -j MASQUERADE &&
        iptables -t nat -A POSTROUTING -s 20.0.0.0/24 -o eth0 -j MASQUERADE &&
        iptables -A FORWARD -s 10.0.0.0/24 -d 20.0.0.0/24 -j ACCEPT &&
        iptables -A FORWARD -s 20.0.0.0/24 -d 10.0.0.0/24 -j ACCEPT &&
        iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT &&
        iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT &&
        service isc-dhcp-server start &&
        tcpdump -i any -w /tcpdump_logs/traffic_nat.pcap &&
        tail -f /dev/null
      "
    volumes:
      - ./dhcpd.conf:/etc/dhcp/dhcpd.conf
      - ./tcpdump_logs:/tcpdump_logs
    environment:
      - DEBIAN_FRONTEND=noninteractive



  
  # Hosts Sub-rede A
  host1_a:
    image: ubuntu:latest
    networks:
      subnet_a:
        ipv4_address: 10.0.0.100
    command: tail -f /dev/null  # Mant√©m o container ativo

  host2_a:
    image: ubuntu:latest
    networks:
      subnet_a:
        ipv4_address: 10.0.0.101
    command: tail -f /dev/null
  

  # Hosts Sub-rede B
  host1_b:
    image: ubuntu:latest
    networks:
      subnet_b:
        ipv4_address: 20.0.0.100
    command: tail -f /dev/null

  host2_b:
    image: ubuntu:latest
    networks:
      subnet_b:
        ipv4_address: 20.0.0.101
    command: tail -f /dev/null

networks:
  subnet_a:
    driver: bridge
    ipam:
      config:
        - subnet: 10.0.0.0/24
  subnet_b:
    driver: bridge
    ipam:
      config:
        - subnet: 20.0.0.0/24
